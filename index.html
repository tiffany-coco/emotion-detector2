<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>æƒ…ç»ªç†è§£è®­ç»ƒç³»ç»Ÿ Â· å››é˜¶æ®µæ¶æ„</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#5b8cff" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020;        /* é»˜è®¤æ·±è‰²ä¸»é¢˜ */
      --panel:#141a2f;
      --text:#e9ecff;
      --muted:#b7c1ffcc;
      --brand:#5b8cff;
      --brand-2:#36d6c1;
      --ok:#21c17a;
      --bad:#ff5d66;
      --warn:#f7b955;
      --card:#0f1530;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --pad: clamp(12px, 1.2vw, 16px);
      --gap: clamp(10px, 1vw, 14px);
      --btn: 60px; /* å¯è§¦è¾¾å°ºå¯¸ */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:"Noto Sans SC", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Hiragino Sans GB"; background:linear-gradient(180deg,#0b1020,#0b1228 50%,#0b1020); color:var(--text);}
    .app{min-height:100%; display:grid; grid-template-rows:auto 1fr auto;}
    header{
      position:sticky; top:0; z-index:20; backdrop-filter:saturate(1.2) blur(8px);
      background:linear-gradient(180deg, rgba(20,26,47,.92), rgba(20,26,47,.75));
      border-bottom:1px solid #2a3255; box-shadow:var(--shadow);
    }
    .bar{display:flex; align-items:center; gap:10px; padding:10px var(--pad);} 
    .logo{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.5px}
    .logo span{background:linear-gradient(90deg,var(--brand),var(--brand-2));-webkit-background-clip:text;background-clip:text;color:transparent}
    .hint{margin-left:auto; display:flex; gap:10px; align-items:center}
    .hint button{background:#1b2242;color:var(--text); border:1px solid #2c3562; padding:10px 14px; border-radius:12px}

    main{padding: var(--pad); max-width:1200px; margin:0 auto; width:100%}
    .grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(240px,1fr)); gap:var(--gap)}
    .card{background:linear-gradient(160deg, #121939, #0d1230); border:1px solid #1f2850; border-radius:var(--radius); padding:18px; box-shadow:var(--shadow)}
    .card h3{margin:0 0 8px 0; font-size:18px}
    .sub{font-size:13px;color:var(--muted)}

    .row{display:flex; gap:var(--gap); flex-wrap:wrap}
    .col{flex:1; min-width:260px}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .toolbar select, .toolbar input[type="range"], .toolbar button{height:44px}

    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; border:1px solid #2c3562; background:#1b2242; color:var(--text); padding:10px 14px; border-radius:14px; text-decoration:none; font-weight:600; cursor:pointer; min-width:44px}
    .btn:hover{border-color:#3c4580}
    .btn.primary{background:linear-gradient(90deg, var(--brand), #6ea3ff); border-color:transparent; color:white}
    .btn.success{background:linear-gradient(90deg, #21c17a, #37d6a2); border-color:transparent}
    .btn.warn{background:linear-gradient(90deg, #f7b955, #f39c12); border-color:transparent}
    .btn.ghost{background:transparent}

    .stage{display:grid; gap:var(--gap)}
    .hero{display:flex; align-items:center; gap:14px; padding:14px; border-radius:16px; border:1px dashed #33406b; background:linear-gradient(180deg,#0c1432,#0c1538)}
    .hero .big{font-size:36px}

    .chips{display:flex; gap:10px; flex-wrap:wrap}
    .chip{border:1px solid #2c3562; padding:8px 12px; border-radius:999px; font-size:13px}

    .game{background:linear-gradient(160deg, #0e1533, #0b1130); border:1px solid #27305a; border-radius:var(--radius); padding:20px; display:grid; gap:14px}
    .game h4{margin:0}
    .choices{display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:12px}
    .choice{font-size:18px; padding:14px; border-radius:14px; border:2px solid #2e396a; background:#151b3b; min-height:56px; display:flex; align-items:center; justify-content:center; user-select:none; touch-action:manipulation}
    .choice:active{transform:scale(.98)}
    .choice.good{border-color:#29c07c; background:linear-gradient(180deg,#132a26,#0f1f1b)}
    .choice.bad{border-color:#ff5d66; background:linear-gradient(180deg,#2a141a,#1b0f11)}

    .score{display:flex; gap:12px; align-items:center; font-weight:700}

    .drag-wrap{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    .drag-src, .drag-target{min-height:160px; border:2px dashed #38457a; border-radius:16px; padding:12px; display:flex; gap:10px; flex-wrap:wrap; align-content:flex-start}
    .draggable{padding:10px 12px; background:#1a2144; border:1px solid #2f3a6b; border-radius:12px; font-size:18px}
    .drag-target.over{background:rgba(91,140,255,0.08)}

    .sort-list{display:flex; gap:12px; flex-wrap:wrap}
    .sort-item{padding:10px 12px; border:2px solid #2e396a; border-radius:12px; background:#151b3b; font-size:16px}

    .badge{padding:4px 8px; border-radius:999px; font-size:12px; background:#1b2242; border:1px solid #2e396a}

    .footer{padding:8px var(--pad); color:var(--muted); font-size:12px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between}

    /* æ‘„åƒå¤´ 
    -------------------------------------------------- */
    .camera{display:grid; gap:10px}
    video{max-width:100%; width:100%; height:auto; border-radius:14px; border:1px solid #2e396a; background:#000}

    /* é€‚é… iPad / ç§»åŠ¨ç«¯ */
    @media (hover:none){
      .choice{min-height:64px; font-size:20px}
      .btn{min-height:52px}
    }
  </style>
</head>
<body>
  <div class="app" id="app" aria-live="polite">
    <header>
      <div class="bar" role="navigation" aria-label="é¡¶æ ">
        <div class="logo" aria-label="æƒ…ç»ªç†è§£è®­ç»ƒç³»ç»Ÿ">
          <div class="big" aria-hidden="true">ğŸ¯</div>
          <div>
            <div>æƒ…ç»ªç†è§£è®­ç»ƒç³»ç»Ÿ</div>
            <small class="sub">å››é˜¶æ®µ Â· è‡ªé€‚åº” Â· æœ¬åœ°éšç§</small>
          </div>
        </div>
        <div class="hint">
          <button class="btn" id="btnHome" title="è¿”å›ä¸»é¡µ">ğŸ  ä¸»é¡µ</button>
          <button class="btn" id="btnSettings" title="è®¾ç½®">âš™ï¸ è®¾ç½®</button>
          <button class="btn" id="btnReport" title="æŠ¥å‘Š">ğŸ“ˆ æŠ¥å‘Š</button>
        </div>
      </div>
    </header>

    <main id="main" tabindex="-1">
      <!-- å†…å®¹ç”± JS æ¸²æŸ“ -->
    </main>

    <footer class="footer">
      <div>ğŸ›¡ï¸ æœ¬åœ°å­˜å‚¨ | æ— éœ€è”ç½‘ | å¯å¯¼å‡º CSV</div>
      <div>Â© <span id="year"></span> æƒ…ç»ªç†è§£è®­ç»ƒç³»ç»Ÿ</div>
    </footer>
  </div>

  <script>
  ;(()=>{
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    const state = {
      profile: { id: 'default', name: 'å­¦ç”ŸA', theme: 'dark', voiceRate: 1.0 },
      score: {}, // { gameId: { correct, wrong, best, lastPlayed } }
      stageProgress: { s1:0, s2:0, s3:0, s4:0 },
      prefs: { sound:true, speech:true, camera:false },
    };

    const STORAGE_KEY = 'emoTrain.v1';
    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){ Object.assign(state, JSON.parse(raw)); }
      }catch(e){ console.warn('load failed', e) }
    }
    function save(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){ console.warn('save failed', e) }
    }

    // è¯­éŸ³æ’­æŠ¥
    function speak(text){
      if(!state.prefs.speech) return;
      try{
        const ut = new SpeechSynthesisUtterance(text);
        ut.lang = 'zh-CN';
        ut.rate = state.profile.voiceRate || 1.0;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(ut);
      }catch(e){ console.warn('speech error', e) }
    }

    // CSV å¯¼å‡º
    function exportCSV(){
      const rows = [['profile','game','correct','wrong','best','lastPlayed']];
      Object.entries(state.score).forEach(([gameId, s])=>{
        rows.push([state.profile.name, gameId, s.correct||0, s.wrong||0, s.best||0, s.lastPlayed||'']);
      });
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `report_${Date.now()}.csv`;
      a.click(); URL.revokeObjectURL(url);
    }

    // è¯„åˆ†ä¸è¿›åº¦
    function bumpScore(gameId, ok){
      const s = state.score[gameId] || (state.score[gameId]={correct:0,wrong:0,best:0,lastPlayed:''});
      if(ok) s.correct++; else s.wrong++;
      s.best = Math.max(s.best, s.correct);
      s.lastPlayed = new Date().toLocaleString();
      save();
      updateHeaderMiniReport();
    }

    function updateHeaderMiniReport(){
      // å¯æ‰©å±•ï¼šé¡¶æ æ˜¾ç¤ºä»Šæ—¥æ­£ç¡®/ç”¨æ—¶ç­‰
    }

    // ä¸»é¢˜åˆ‡æ¢
    function applyTheme(){
      if(state.profile.theme === 'light'){
        document.documentElement.style.setProperty('--bg', '#f7f8ff');
        document.documentElement.style.setProperty('--panel', '#ffffff');
        document.documentElement.style.setProperty('--text', '#0e1020');
        document.documentElement.style.setProperty('--muted', '#3c4680');
        document.documentElement.style.setProperty('--card', '#f2f4ff');
      }else if(state.profile.theme === 'hc'){
        document.documentElement.style.setProperty('--bg', '#000');
        document.documentElement.style.setProperty('--panel', '#000');
        document.documentElement.style.setProperty('--text', '#fff');
        document.documentElement.style.setProperty('--muted', '#fff');
        document.documentElement.style.setProperty('--brand', '#fff');
        document.documentElement.style.setProperty('--brand-2', '#fff');
        document.documentElement.style.setProperty('--card', '#000');
      }else{
        // dark é»˜è®¤
        document.documentElement.style.setProperty('--bg', '#0b1020');
        document.documentElement.style.setProperty('--panel', '#141a2f');
        document.documentElement.style.setProperty('--text', '#e9ecff');
        document.documentElement.style.setProperty('--muted', '#b7c1ffcc');
        document.documentElement.style.setProperty('--card', '#0f1530');
      }
    }

    // è·¯ç”±ï¼ˆhashï¼‰
    const routes = {
      '': renderHome,
      '#home': renderHome,
      '#settings': renderSettings,
      '#report': renderReport,
      '#g1': ()=>renderGame1('g1'),           // æƒ…ç»ªæŒ‡è®¤
      '#g2': ()=>renderGame2('g2'),           // æƒ…ç»ªé…å¯¹ï¼ˆæ‹–æ‹½ï¼‰
      '#g5': ()=>renderGame5('g5'),           // å¼ºåº¦æ’åº
      '#g8': ()=>renderGame8('g8'),           // æƒ…ç»ªè°ƒèŠ‚ç­–ç•¥
      '#g12':()=>renderGame12('g12'),         // æ¶ˆé™¤åæƒ…ç»ª
      // å…¶ä»–æ¸¸æˆå ä½
      '#g3': ()=>renderComing('g3','æƒ…ç»ªæ¨¡ä»¿ï¼ˆæ”¯æŒæ‘„åƒå¤´ï¼‰'),
      '#g4': ()=>renderComing('g4','æƒ…å¢ƒé…å¯¹'),
      '#g6': ()=>renderComing('g6','æƒ…ç»ªåŸå› æ¨æµ‹'),
      '#g7': ()=>renderComing('g7','ç¤¾ä¼šæƒ…å¢ƒå†³ç­–'),
      '#g9': ()=>renderComing('g9','å…±æƒ…ç†è§£'),
      '#g10':()=>renderComing('g10','æƒ…ç»ªè®°å¿†'),
      '#g11':()=>renderComing('g11','æƒ…ç»ªç»˜ç”»è¡¨è¾¾'),
    };

    function router(){
      const hash = location.hash || '#home';
      (routes[hash]||renderHome)();
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // UI ç‰‡æ®µ
    function stageCard(icon, title, items){
      return `<div class="card stage" role="group" aria-label="${title}">
        <div class="hero"><div class="big">${icon}</div><div>
          <h3>${title}</h3>
          <div class="sub">å¾ªåºæ¸è¿› Â· éš¾åº¦è‡ªé€‚åº”</div>
        </div></div>
        <div class="grid">
          ${items.map(x=>`<div class="game" aria-live="polite">
            <h4>${x.idx}. ${x.name}</h4>
            <div class="chips"><span class="chip">${x.tag}</span><span class="chip">æœ€ä½³ï¼š${(state.score[x.hash]?.best)||0}</span></div>
            <div class="toolbar">
              <button class="btn primary" onclick="location.hash='${x.hash}'">è¿›å…¥è®­ç»ƒ</button>
              <small class="sub">æœ€è¿‘ï¼š${(state.score[x.hash]?.lastPlayed)||'â€”'}</small>
            </div>
          </div>`).join('')}
        </div>
      </div>`
    }

    function renderHome(){
      const el = $('#main');
      el.innerHTML = `
        <section class="row" aria-label="æ¦‚è§ˆ">
          <div class="col card">
            <h3>æ¬¢è¿ï¼Œ${state.profile.name}</h3>
            <p class="sub">é€‰æ‹©ä¸€ä¸ªé˜¶æ®µå¼€å§‹è®­ç»ƒã€‚ç³»ç»Ÿä¼šè®°å½•ä½ çš„å¾—åˆ†ä¸æœ€ä½³æˆç»©ï¼Œå¹¶å¯å¯¼å‡ºæ•°æ®ã€‚</p>
            <div class="chips">
              <span class="chip">è¯­éŸ³ï¼š${state.prefs.speech? 'å¼€å¯' : 'å…³é—­'}</span>
              <span class="chip">ç›¸æœºï¼š${state.prefs.camera? 'å…è®¸' : 'ç¦æ­¢'}</span>
              <span class="chip">ä¸»é¢˜ï¼š${state.profile.theme}</span>
            </div>
            <div style="margin-top:12px" class="toolbar">
              <button class="btn" onclick="location.hash='#settings'">âš™ï¸ å¿«é€Ÿè®¾ç½®</button>
              <button class="btn" onclick="location.hash='#report'">ğŸ“ˆ æŸ¥çœ‹æŠ¥å‘Š</button>
              <button class="btn" onclick="(${exportCSV.toString()})()">ğŸ§¾ å¯¼å‡ºCSV</button>
            </div>
          </div>
        </section>
        <section class="stage-list" aria-label="é˜¶æ®µåˆ—è¡¨" style="display:grid; gap:16px; margin-top:12px">
          ${stageCard('ğŸµ','ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ„ŸçŸ¥ä¸è¯†åˆ«',[
            {idx:1, name:'æƒ…ç»ªæŒ‡è®¤æ¸¸æˆ', tag:'2â†’4 é€‰é¡¹ Â· è¯­éŸ³æç¤º', hash:'#g1'},
            {idx:2, name:'æƒ…ç»ªé…å¯¹æ¸¸æˆ', tag:'æ‹–æ‹½ Â· æ³›åŒ–', hash:'#g2'},
            {idx:3, name:'æƒ…ç»ªæ¨¡ä»¿æ¸¸æˆ', tag:'é•œåƒ Â· æ•™å¸ˆè¯„ä»·', hash:'#g3'},
          ])}
          ${stageCard('ğŸ“š','ç¬¬äºŒé˜¶æ®µï¼šæƒ…å¢ƒç†è§£ä¸åº”ç”¨',[
            {idx:4, name:'æƒ…å¢ƒé…å¯¹æ¸¸æˆ', tag:'å›¾ç‰‡+æ–‡å­— Â· å› æœè§£é‡Š', hash:'#g4'},
            {idx:5, name:'æƒ…ç»ªå¼ºåº¦æ’åº', tag:'è½»â†’å¼º Â· æ’åº', hash:'#g5'},
            {idx:6, name:'æƒ…ç»ªåŸå› æ¨æµ‹', tag:'åæ¨ Â· å¹²æ‰°é€‰é¡¹', hash:'#g6'},
          ])}
          ${stageCard('ğŸ‘¥','ç¬¬ä¸‰é˜¶æ®µï¼šç¤¾ä¼šè®¤çŸ¥ä¸è°ƒèŠ‚',[
            {idx:7, name:'ç¤¾ä¼šæƒ…å¢ƒå†³ç­–', tag:'åæœé¢„æµ‹', hash:'#g7'},
            {idx:8, name:'æƒ…ç»ªè°ƒèŠ‚ç­–ç•¥', tag:'å‘¼å¸/æ•°æ•°/æ±‚åŠ©/ç»˜ç”»', hash:'#g8'},
            {idx:9, name:'å…±æƒ…ç†è§£æ¸¸æˆ', tag:'è§‚ç‚¹é‡‡æ‹©', hash:'#g9'},
          ])}
          ${stageCard('ğŸŒŸ','ç¬¬å››é˜¶æ®µï¼šç»¼åˆåº”ç”¨ä¸æ³›åŒ–',[
            {idx:10, name:'æƒ…ç»ªè®°å¿†æ¸¸æˆ', tag:'åºåˆ—è®°å¿†', hash:'#g10'},
            {idx:11, name:'æƒ…ç»ªç»˜ç”»è¡¨è¾¾', tag:'ç”»å¸ƒå·¥å…·', hash:'#g11'},
            {idx:12, name:'æ¶ˆé™¤åæƒ…ç»ªæ¸¸æˆ', tag:'å¿«é€Ÿè¯†åˆ« Â· å¼ºåŒ–', hash:'#g12'},
          ])}
        </section>
      `;
      $('#btnHome').disabled = true; $('#btnSettings').disabled=false; $('#btnReport').disabled=false;
      speak('æ¬¢è¿æ¥åˆ°æƒ…ç»ªç†è§£è®­ç»ƒç³»ç»Ÿã€‚è¯·é€‰æ‹©ä¸€ä¸ªæ¸¸æˆå¼€å§‹è®­ç»ƒã€‚');
    }

    function renderSettings(){
      const el = $('#main');
      el.innerHTML = `
        <section class="card" aria-label="è®¾ç½®">
          <h3>âš™ï¸ è®¾ç½®</h3>
          <div class="row" style="margin-top:8px">
            <div class="col">
              <div class="game">
                <h4>ä¸ªäººä¿¡æ¯</h4>
                <label class="sub">å§“å/æ˜µç§°</label>
                <input id="nameInput" type="text" value="${state.profile.name}" style="height:44px;border-radius:12px;border:1px solid #2c3562;background:#0f1530;color:var(--text);padding:0 12px"/>
                <div class="chips">
                  <span class="badge">ID: ${state.profile.id}</span>
                </div>
                <div class="toolbar">
                  <button class="btn success" id="saveProfile">ä¿å­˜</button>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="game">
                <h4>åå¥½</h4>
                <div class="toolbar">
                  <label><input type="checkbox" id="speechChk" ${state.prefs.speech?'checked':''}/> è¯­éŸ³æ’­æŠ¥</label>
                  <label><input type="checkbox" id="soundChk" ${state.prefs.sound?'checked':''}/> æç¤ºéŸ³</label>
                  <label><input type="checkbox" id="camChk" ${state.prefs.camera?'checked':''}/> æ‘„åƒå¤´</label>
                </div>
                <label class="sub">è¯­é€Ÿï¼š<span id="rateVal">${state.profile.voiceRate.toFixed(1)}</span></label>
                <input id="rateRange" type="range" min="0.6" max="1.6" step="0.1" value="${state.profile.voiceRate}" style="width:100%"/>
                <label class="sub">ä¸»é¢˜</label>
                <div class="toolbar">
                  <button class="btn" data-theme="dark">ğŸŒ™ æ·±è‰²</button>
                  <button class="btn" data-theme="light">â˜€ï¸ æµ…è‰²</button>
                  <button class="btn" data-theme="hc">ğŸŸ¡ é«˜å¯¹æ¯”</button>
                </div>
              </div>
            </div>
          </div>
          <div class="toolbar" style="margin-top:10px">
            <button class="btn" onclick="(${exportCSV.toString()})()">ğŸ§¾ å¯¼å‡ºCSV</button>
            <button class="btn warn" id="resetAll">é‡ç½®å…¨éƒ¨æ•°æ®</button>
          </div>
        </section>
      `;
      $('#btnHome').disabled=false; $('#btnSettings').disabled=true; $('#btnReport').disabled=false;

      $('#saveProfile').onclick = ()=>{ state.profile.name = $('#nameInput').value.trim()||state.profile.name; save(); speak('å·²ä¿å­˜ã€‚'); };
      $('#speechChk').onchange = e=>{ state.prefs.speech = e.target.checked; save(); };
      $('#soundChk').onchange = e=>{ state.prefs.sound = e.target.checked; save(); };
      $('#camChk').onchange = e=>{ state.prefs.camera = e.target.checked; save(); };
      $('#rateRange').oninput = e=>{ state.profile.voiceRate = parseFloat(e.target.value); $('#rateVal').textContent = state.profile.voiceRate.toFixed(1); };
      $$('.toolbar .btn[data-theme]').forEach(b=> b.onclick = ()=>{ state.profile.theme = b.dataset.theme; applyTheme(); save(); });
      $('#resetAll').onclick = ()=>{ if(confirm('ç¡®å®šè¦é‡ç½®å…¨éƒ¨è¿›åº¦ä¸è®¾ç½®ï¼Ÿ')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } };
    }

    function renderReport(){
      const el = $('#main');
      const list = Object.entries(state.score);
      const totalCorrect = list.reduce((a,[,s])=>a+(s.correct||0),0);
      const totalWrong = list.reduce((a,[,s])=>a+(s.wrong||0),0);
      el.innerHTML = `
        <section class="card">
          <h3>ğŸ“ˆ å­¦ä¹ æŠ¥å‘Š</h3>
          <div class="chips">
            <span class="chip">æ€»æ­£ç¡®ï¼š${totalCorrect}</span>
            <span class="chip">æ€»é”™è¯¯ï¼š${totalWrong}</span>
            <span class="chip">æ¸¸æˆæ•°é‡ï¼š${list.length}</span>
          </div>
          <div style="margin-top:10px">
            <table style="width:100%; border-collapse:collapse; font-size:14px">
              <thead><tr>
                <th style="text-align:left; border-bottom:1px solid #2c3562; padding:8px">æ¸¸æˆ</th>
                <th style="text-align:right; border-bottom:1px solid #2c3562; padding:8px">æ­£ç¡®</th>
                <th style="text-align:right; border-bottom:1px solid #2c3562; padding:8px">é”™è¯¯</th>
                <th style="text-align:right; border-bottom:1px solid #2c3562; padding:8px">æœ€ä½³</th>
                <th style="text-align:right; border-bottom:1px solid #2c3562; padding:8px">æœ€è¿‘</th>
              </tr></thead>
              <tbody>
              ${list.map(([id,s])=>`<tr>
                <td style="padding:8px; border-bottom:1px dashed #2c3562">${id}</td>
                <td style="padding:8px; border-bottom:1px dashed #2c3562; text-align:right">${s.correct||0}</td>
                <td style="padding:8px; border-bottom:1px dashed #2c3562; text-align:right">${s.wrong||0}</td>
                <td style="padding:8px; border-bottom:1px dashed #2c3562; text-align:right">${s.best||0}</td>
                <td style="padding:8px; border-bottom:1px dashed #2c3562; text-align:right">${s.lastPlayed||'â€”'}</td>
              </tr>`).join('')}
              </tbody>
            </table>
          </div>
          <div class="toolbar" style="margin-top:12px">
            <button class="btn" onclick="(${exportCSV.toString()})()">ğŸ§¾ å¯¼å‡ºCSV</button>
            <button class="btn" onclick="location.hash='#home'">è¿”å›</button>
          </div>
        </section>
      `;
      $('#btnHome').disabled=false; $('#btnSettings').disabled=false; $('#btnReport').disabled=true;
    }

    function renderComing(gameId, title){
      const el = $('#main');
      el.innerHTML = `
        <section class="card">
          <h3>â³ ${title}</h3>
          <p class="sub">è¯¥æ¸¸æˆçš„å ä½ç•Œé¢ã€‚ä½ å¯ä»¥å…ˆå¼€å±•å…¶ä»–å·²å®ç°çš„è®­ç»ƒï¼š#g1ã€#g2ã€#g5ã€#g8ã€#g12ã€‚</p>
          <div class="toolbar"><button class="btn" onclick="location.hash='#home'">è¿”å›ä¸»é¡µ</button></div>
        </section>
      `;
    }

    // Game 1: æƒ…ç»ªæŒ‡è®¤ï¼ˆ2â†’4 é€‰é¡¹ Â· è¯­éŸ³ï¼‰
    function renderGame1(gameId){
      const all = [
        {emo:'é«˜å…´', icon:'ğŸ˜Š'},
        {emo:'ä¼¤å¿ƒ', icon:'ğŸ˜¢'},
        {emo:'ç”Ÿæ°”', icon:'ğŸ˜ '},
        {emo:'å®³æ€•', icon:'ğŸ˜¨'},
      ];
      // éš¾åº¦æ ¹æ®å†å²æˆç»©è°ƒæ•´ï¼ˆ2~4 é€‰é¡¹ï¼‰
      const s = state.score[gameId]||{};
      const level = Math.min(4, 2 + Math.floor((s.best||0)/5));
      const pool = all.slice(0, level);
      const ans = pool[Math.floor(Math.random()*pool.length)];
      const choices = [...pool].sort(()=>Math.random()-0.5);

      const el = $('#main');
      el.innerHTML = `
        <section class="game" aria-label="æƒ…ç»ªæŒ‡è®¤">
          <div class="hero"><div class="big" aria-hidden="true">ğŸµ</div><div>
            <h3>1. è¿™æ˜¯ä»€ä¹ˆæƒ…ç»ªï¼Ÿ</h3>
            <div class="sub">éš¾åº¦ï¼š${level} é€‰é¡¹</div>
          </div></div>
          <div class="card" style="text-align:center">
            <div style="font-size:80px; line-height:1" aria-label="ç›®æ ‡è¡¨æƒ…">${ans.icon}</div>
            <div class="sub" style="margin-top:6px">è¯·æŒ‡è®¤ï¼šè¿™æ˜¯ä»€ä¹ˆæƒ…ç»ªï¼Ÿ</div>
          </div>
          <div class="choices" role="list" aria-label="é€‰æ‹©åŒº">
            ${choices.map(c=>`<button class="choice" role="listitem" data-v="${c.emo}">${c.emo}</button>`).join('')}
          </div>
          <div class="row" style="align-items:center; justify-content:space-between">
            <div class="score">âœ… ${(s.correct||0)} &nbsp; âŒ ${(s.wrong||0)} &nbsp; ğŸ† æœ€ä½³ ${(s.best||0)}</div>
            <div class="toolbar">
              <button class="btn" onclick="location.hash='#home'">è¿”å›</button>
              <button class="btn primary" id="nextQ">ä¸‹ä¸€é¢˜</button>
            </div>
          </div>
        </section>
      `;
      speak('è¿™æ˜¯ä»€ä¹ˆæƒ…ç»ªï¼Ÿ');

      $$('.choice').forEach(b=> b.onclick = ()=>{
        const ok = b.dataset.v === ans.emo;
        b.classList.add(ok?'good':'bad');
        bumpScore(gameId, ok);
        if(ok) speak(`å¤ªæ£’äº†ï¼è¿™æ˜¯${ans.emo}`); else speak(`å†æƒ³æƒ³ï¼Œè¿™æ˜¯${ans.emo}å“¦`);
      });
      $('#nextQ').onclick = ()=> renderGame1(gameId);
    }

    // Game 2: æƒ…ç»ªé…å¯¹ï¼ˆæ‹–æ‹½ï¼‰
    function renderGame2(gameId){
      const targets = ['é«˜å…´','ä¼¤å¿ƒ','ç”Ÿæ°”','å®³æ€•'];
      const emoIcon = {é«˜å…´:'ğŸ˜Š',ä¼¤å¿ƒ:'ğŸ˜¢',ç”Ÿæ°”:'ğŸ˜ ',å®³æ€•:'ğŸ˜¨'};
      // éš¾åº¦ï¼š2â†’4 ç±»åˆ«
      const s = state.score[gameId]||{};
      const k = Math.min(4, 2 + Math.floor((s.best||0)/4));
      const cats = targets.slice(0,k);
      const samples = cats.flatMap(c=>[
        {emo:c, label:`${emoIcon[c]} ${c}â‘ `},
        {emo:c, label:`${emoIcon[c]} ${c}â‘¡`}
      ]).sort(()=>Math.random()-0.5);

      const el = $('#main');
      el.innerHTML = `
        <section class="game" aria-label="æƒ…ç»ªé…å¯¹">
          <div class="hero"><div class="big" aria-hidden="true">ğŸµ</div><div>
            <h3>2. æŠŠç›¸åŒæƒ…ç»ªæ‹–åˆ°å¯¹åº”æ¡†å†…</h3>
            <div class="sub">è®­ç»ƒæƒ…ç»ªæ³›åŒ–èƒ½åŠ› Â· éš¾åº¦ï¼š${k} ç±»åˆ«</div>
          </div></div>
          <div class="drag-wrap">
            <div class="drag-src" id="dragSrc" aria-label="å¾…åˆ†ç±»">
              ${samples.map((s,i)=>`<div class="draggable" draggable="true" data-emo="${s.emo}" aria-grabbed="false" role="button">${s.label}</div>`).join('')}
            </div>
            <div class="drag-targets">
              ${cats.map(c=>`<div class="drag-target" data-emo="${c}" aria-label="ç›®æ ‡ ${c}"><div class="sub">ç›®æ ‡æƒ…ç»ªï¼š${c}</div></div>`).join('')}
            </div>
          </div>
          <div class="toolbar" style="justify-content:space-between">
            <div class="score">âœ… ${(s.correct||0)} &nbsp; âŒ ${(s.wrong||0)} &nbsp; ğŸ† æœ€ä½³ ${(s.best||0)}</div>
            <div>
              <button class="btn" onclick="location.hash='#home'">è¿”å›</button>
              <button class="btn primary" id="nextQ">ä¸‹ä¸€è½®</button>
            </div>
          </div>
        </section>
      `;

      const onDragStart = (e)=>{ e.dataTransfer.setData('text/plain', e.target.dataset.emo); e.dataTransfer.dropEffect='move'; e.target.classList.add('dragging'); };
      const onDragEnd = (e)=>{ e.target.classList.remove('dragging'); };
      const onDragOver = (e)=>{ e.preventDefault(); e.currentTarget.classList.add('over'); };
      const onLeave = (e)=>{ e.currentTarget.classList.remove('over'); };
      const onDrop = (e)=>{
        e.preventDefault();
        const expect = e.currentTarget.dataset.emo;
        const dragging = $('.dragging');
        if(!dragging) return;
        const got = dragging.dataset.emo;
        if(expect === got){
          e.currentTarget.appendChild(dragging);
          dragging.classList.remove('dragging');
          bumpScore(gameId, true);
          speak(`æ­£ç¡®ï¼Œ${expect}`);
        }else{
          bumpScore(gameId, false);
          speak(`ä¸æ˜¯è¿™é‡Œï¼Œè¯•è¯•åˆ«çš„ç›®æ ‡`);
        }
        e.currentTarget.classList.remove('over');
      };

      $$('.draggable').forEach(d=>{ d.addEventListener('dragstart', onDragStart); d.addEventListener('dragend', onDragEnd); });
      $$('.drag-target').forEach(t=>{
        t.addEventListener('dragover', onDragOver);
        t.addEventListener('dragleave', onLeave);
        t.addEventListener('drop', onDrop);
      });
      $('#nextQ').onclick = ()=> renderGame2(gameId);
    }

    // Game 5: æƒ…ç»ªå¼ºåº¦æ’åºï¼ˆè½»â†’å¼ºï¼‰
    function renderGame5(gameId){
      const emo = 'ç”Ÿæ°”';
      const items = [
        {key:'è½»å¾®', label:'è½»å¾®ç”Ÿæ°” ğŸ˜•'},
        {key:'ä¸­ç­‰', label:'ä¸­ç­‰ç”Ÿæ°” ğŸ˜ '},
        {key:'å¼ºçƒˆ', label:'éå¸¸ç”Ÿæ°” ğŸ¤¬'},
      ].sort(()=>Math.random()-0.5);
      const el = $('#main');
      el.innerHTML = `
        <section class="game" aria-label="æƒ…ç»ªå¼ºåº¦æ’åº">
          <div class="hero"><div class="big" aria-hidden="true">ğŸ“š</div><div>
            <h3>5. è¯·æŒ‰ä»è½»å¾®åˆ°å¼ºçƒˆçš„é¡ºåºæ’åˆ—ã€Œ${emo}ã€</h3>
            <div class="sub">æ‹–åŠ¨å¡ç‰‡æ’åºåç‚¹å‡»æ ¡éªŒ</div>
          </div></div>
          <div class="sort-list" id="sortList">
            ${items.map(i=>`<div class="sort-item" draggable="true" data-key="${i.key}">${i.label}</div>`).join('')}
          </div>
          <div class="toolbar" style="justify-content:space-between">
            <div class="score">âœ… ${(state.score[gameId]?.correct||0)} &nbsp; âŒ ${(state.score[gameId]?.wrong||0)} &nbsp; ğŸ† æœ€ä½³ ${(state.score[gameId]?.best||0)}</div>
            <div>
              <button class="btn" onclick="location.hash='#home'">è¿”å›</button>
              <button class="btn primary" id="checkOrder">æ ¡éªŒ</button>
            </div>
          </div>
        </section>
      `;

      // ç®€æ˜“æ‹–æ‹½æ’åºï¼ˆåŒå®¹å™¨ï¼‰
      const list = $('#sortList');
      let dragEl = null;
      list.addEventListener('dragstart', e=>{ dragEl = e.target; e.dataTransfer.effectAllowed='move'; });
      list.addEventListener('dragover', e=>{
        e.preventDefault();
        const after = Array.from(list.children).find(ch=>{
          const rect= ch.getBoundingClientRect();
          return e.clientX < rect.left + rect.width/2;
        });
        if(after) list.insertBefore(dragEl, after); else list.appendChild(dragEl);
      });
      list.addEventListener('dragend', ()=> dragEl=null);

      $('#checkOrder').onclick = ()=>{
        const keys = $$('.sort-item', list).map(el=>el.dataset.key);
        const ok = JSON.stringify(keys) === JSON.stringify(['è½»å¾®','ä¸­ç­‰','å¼ºçƒˆ']);
        bumpScore(gameId, ok);
        if(ok){ speak('æ­£ç¡®ï¼Œä»è½»å¾®åˆ°å¼ºçƒˆã€‚'); } else { speak('é¡ºåºä¸å¯¹ï¼Œå†è¯•ä¸€æ¬¡ã€‚'); }
      };
    }

    // Game 8: æƒ…ç»ªè°ƒèŠ‚ç­–ç•¥
    function renderGame8(gameId){
      const el = $('#main');
      el.innerHTML = `
        <section class="game" aria-label="æƒ…ç»ªè°ƒèŠ‚ç­–ç•¥">
          <div class="hero"><div class="big" aria-hidden="true">ğŸ‘¥</div><div>
            <h3>8. æˆ‘ç°åœ¨å¾ˆç”Ÿæ°”ï¼Œå¯ä»¥æ€ä¹ˆåšï¼Ÿ</h3>
            <div class="sub">é€‰æ‹©ä¸€ä¸ªç­–ç•¥å¹¶è·Ÿéšæç¤ºæ‰§è¡Œ</div>
          </div></div>
          <div class="choices" id="strats">
            <button class="choice" data-act="breath">ğŸ’¨ æ·±å‘¼å¸5æ¬¡</button>
            <button class="choice" data-act="count">ğŸ”¢ ä»1æ•°åˆ°10</button>
            <button class="choice" data-act="adult">ğŸ‘¥ æ‰¾å¤§äººå¸®å¿™</button>
            <button class="choice" data-act="draw">ğŸ¨ ç”»ç”»è¡¨è¾¾æƒ…ç»ª</button>
          </div>
          <div id="coach" class="card" aria-live="polite"><div class="sub">é€‰æ‹©ä¸€ä¸ªç­–ç•¥ï¼Œç³»ç»Ÿä¼šç»™äºˆåˆ†æ­¥æŒ‡å¯¼ã€‚</div></div>
          <div class="toolbar" style="justify-content:space-between">
            <div class="score">âœ… ${(state.score[gameId]?.correct||0)} &nbsp; âŒ ${(state.score[gameId]?.wrong||0)} &nbsp; ğŸ† æœ€ä½³ ${(state.score[gameId]?.best||0)}</div>
            <div>
              <button class="btn" onclick="location.hash='#home'">è¿”å›</button>
            </div>
          </div>
        </section>
      `;
      const coach = $('#coach');
      $('#strats').onclick = (e)=>{
        const b = e.target.closest('.choice'); if(!b) return;
        const act = b.dataset.act;
        if(act==='breath'){
          coach.innerHTML = `<h4>ç»ƒä¹ ï¼šæ·±å‘¼å¸</h4><ol><li>å¸æ°” 4 ç§’</li><li>å±æ¯ 2 ç§’</li><li>å‘¼æ°” 4 ç§’</li><li>é‡å¤ 5 æ¬¡</li></ol>`;
          speak('è·Ÿç€æˆ‘ï¼Œä¸€èµ·åšäº”æ¬¡æ·±å‘¼å¸ã€‚å¸æ°”å››ç§’ï¼Œåœä¸¤ç§’ï¼Œå‘¼æ°”å››ç§’ã€‚');
          bumpScore(gameId, true);
        }else if(act==='count'){
          coach.innerHTML = `<h4>ç»ƒä¹ ï¼šæ•°æ•°</h4><p>æ…¢æ…¢ä» 1 æ•°åˆ° 10ï¼Œé…åˆå‡åŒ€å‘¼å¸ã€‚</p>`;
          speak('æ…¢æ…¢ä»ä¸€æ•°åˆ°åã€‚'); bumpScore(gameId, true);
        }else if(act==='adult'){
          coach.innerHTML = `<h4>æ±‚åŠ©ï¼šæ‰¾å¤§äºº</h4><p>ç°åœ¨è¯·æ‰¾åˆ°è€å¸ˆæˆ–å®¶é•¿ï¼Œæ¸…æ¥šåœ°æè¿°å‘ç”Ÿäº†ä»€ä¹ˆå’Œä½ çš„æ„Ÿå—ã€‚</p>`;
          speak('å»æ‰¾å¤§äººå¸®å¿™ï¼ŒæŠŠå‘ç”Ÿçš„äº‹æƒ…å’Œä½ çš„æ„Ÿå—è¯´æ¸…æ¥šã€‚'); bumpScore(gameId, true);
        }else if(act==='draw'){
          coach.innerHTML = `<h4>è¡¨è¾¾ï¼šç”»ç”»</h4><p>æ‹¿èµ·çº¸ç¬”ï¼ŒæŠŠä½ çš„æ„Ÿå—ç”»å‡ºæ¥ï¼Œç”»å®Œåç»™è€å¸ˆçœ‹çœ‹ã€‚</p>`;
          speak('æ‹¿èµ·çº¸ç¬”ï¼ŒæŠŠä½ çš„æ„Ÿå—ç”»å‡ºæ¥ã€‚'); bumpScore(gameId, true);
        }
      };
    }

    // Game 12: æ¶ˆé™¤åæƒ…ç»ªï¼ˆç‚¹å‡»è´Ÿé¢æ³¡æ³¡ï¼‰
    function renderGame12(gameId){
      const pos = ['ğŸ˜Š','ğŸ¥°','ğŸ˜','ğŸ˜„'];
      const neg = ['ğŸ˜ ','ğŸ˜¢','ğŸ˜¨','ğŸ˜'];
      const pool = [...pos, ...neg].sort(()=>Math.random()-0.5).slice(0,8);
      const need = pool.filter(x=>neg.includes(x)).length;
      const el = $('#main');
      el.innerHTML = `
        <section class="game" aria-label="æ¶ˆé™¤åæƒ…ç»ª">
          <div class="hero"><div class="big" aria-hidden="true">ğŸŒŸ</div><div>
            <h3>12. ç‚¹å‡»æ¶ˆé™¤æ‰€æœ‰è´Ÿé¢æƒ…ç»ª</h3>
            <div class="sub">å·²æ¶ˆé™¤ï¼š<span id="killed">0</span> / ${need} ä¸ªè´Ÿé¢æƒ…ç»ª</div>
          </div></div>
          <div class="choices" id="bubbles" style="grid-template-columns:repeat(auto-fit,minmax(90px,1fr))">
            ${pool.map((e,i)=>`<button class="choice" data-emo="${e}" style="font-size:32px; min-height:80px">${e}</button>`).join('')}
          </div>
          <div class="toolbar" style="justify-content:space-between">
            <div class="score">âœ… ${(state.score[gameId]?.correct||0)} &nbsp; âŒ ${(state.score[gameId]?.wrong||0)} &nbsp; ğŸ† æœ€ä½³ ${(state.score[gameId]?.best||0)}</div>
            <div>
              <button class="btn" onclick="location.hash='#home'">è¿”å›</button>
              <button class="btn primary" id="again">å†æ¥ä¸€è½®</button>
            </div>
          </div>
        </section>
      `;

      let killed = 0;
      $('#bubbles').onclick = (e)=>{
        const b = e.target.closest('.choice'); if(!b) return;
        const emo = b.dataset.emo;
        const isNeg = ['ğŸ˜ ','ğŸ˜¢','ğŸ˜¨','ğŸ˜'].includes(emo);
        if(isNeg){
          b.classList.add('good');
          b.disabled = true;
          killed++; $('#killed').textContent = killed;
          bumpScore(gameId, true);
          if(killed===need){ speak('åšå¾—å¥½ï¼ä½ æ¸…é™¤äº†æ‰€æœ‰è´Ÿé¢æƒ…ç»ªã€‚'); }
        }else{
          b.classList.add('bad');
          bumpScore(gameId, false);
          speak('è¿™æ˜¯ç§¯ææƒ…ç»ªï¼Œç•™ä¸‹å®ƒã€‚');
          setTimeout(()=> b.classList.remove('bad'), 500);
        }
      };
      $('#again').onclick = ()=> renderGame12(gameId);
    }

    // æ‘„åƒå¤´ï¼ˆä¾› g3 ç­‰ä½¿ç”¨ï¼‰
    async function startCamera(videoEl){
      if(!state.prefs.camera){ alert('æœªåœ¨è®¾ç½®ä¸­å¼€å¯æ‘„åƒå¤´æƒé™'); return; }
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
        videoEl.srcObject = stream; await videoEl.play();
      }catch(e){ alert('æ— æ³•æ‰“å¼€æ‘„åƒå¤´ï¼š'+e.message) }
    }

    // äº‹ä»¶ç»‘å®š & åˆå§‹åŒ–
    function bindGlobals(){
      $('#btnHome').onclick = ()=> location.hash = '#home';
      $('#btnSettings').onclick = ()=> location.hash = '#settings';
      $('#btnReport').onclick = ()=> location.hash = '#report';
      window.addEventListener('hashchange', router);
      $('#year').textContent = new Date().getFullYear();
    }

    // å¯åŠ¨
    load(); applyTheme(); bindGlobals(); router();
  })();
  </script>
</body>
</html>

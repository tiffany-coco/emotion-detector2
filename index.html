<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>é˜¶æ®µä¸€ Â· åŸºç¡€æ„ŸçŸ¥ä¸è¯†åˆ«</title>
<style>
  :root{--bg:#0b1020;--panel:#0f1530;--line:#2a3561;--text:#e9edff;--muted:#aab4ff;--ok:#27c17d;--bad:#ff5d6a;--brand:#5b8cff;--r:18px}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b1020,#0b1126);color:var(--text);font-family:-apple-system,system-ui,"PingFang SC","Noto Sans SC",Arial}
  .app{min-height:100%;display:grid;grid-template-rows:auto 1fr auto;max-width:520px;margin:0 auto}
  header{position:sticky;top:0;background:rgba(15,21,48,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:20}
  .bar{display:flex;align-items:center;gap:10px;padding:10px 14px}
  .bar h1{font-size:18px;margin:0;font-weight:800}
  .bar .act{margin-left:auto;display:flex;gap:8px}
  .btn{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--line);background:#151d42;color:var(--text);border-radius:14px;padding:10px 14px;font-weight:700;min-height:44px;min-width:44px;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
  .btn.primary{background:linear-gradient(90deg,var(--brand),#73a4ff);border-color:transparent;color:#fff}
  .btn.ghost{background:transparent}
  .btn:active{transform:scale(.98)}
  main{padding:12px}
  .sec{background:linear-gradient(160deg,var(--panel),#0d1330);border:1px solid var(--line);border-radius:var(--r);padding:12px;margin-bottom:12px}
  .sec h2{font-size:16px;margin:0 0 8px 0}
  .grid{display:grid;grid-template-columns:1fr;gap:8px}
  .tile{display:flex;align-items:center;gap:10px;background:linear-gradient(160deg,#121a3a,#0e1533);border:1px solid var(--line);border-radius:14px;padding:12px}
  .tile .ico{font-size:24px}
  .tile .meta{margin-left:auto;color:var(--muted);font-size:12px}
  .hero{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .hero .ico{font-size:22px}
  .card{background:linear-gradient(160deg,#11183a,#0d1330);border:1px solid var(--line);border-radius:16px;padding:12px}
  .face{font-size:84px;line-height:1;text-align:center}
  .choices{display:grid;grid-template-columns:1fr;gap:10px}
  .choice{border:2px solid var(--line);border-radius:14px;background:#151d42;color:var(--text);min-height:64px;font-size:18px;font-weight:700}
  .choice.good{border-color:var(--ok);background:linear-gradient(180deg,#10271f,#0e1f19)}
  .choice.bad{border-color:var(--bad);background:linear-gradient(180deg,#2a1620,#1c0f14)}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#1b234a;color:var(--muted);font-size:12px}
  .drag-wrap{display:grid;gap:10px}
  .dropzone{min-height:120px;border:2px dashed var(--line);border-radius:14px;padding:10px;display:flex;gap:8px;flex-wrap:wrap}
  .draggable{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#1a2147;font-size:18px}
  .dropzone.over{background:rgba(91,140,255,.08)}
  .camera{display:grid;gap:10px}
  video{width:100%;height:auto;border-radius:12px;border:1px solid var(--line);background:#000}
  footer{padding:8px 14px;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="bar">
      <h1>ğŸµ é˜¶æ®µä¸€ Â· åŸºç¡€æ„ŸçŸ¥ä¸è¯†åˆ«</h1>
      <div class="act">
        <button class="btn" id="btnHome">ğŸ </button>
        <button class="btn" id="btnReport">ğŸ“ˆ</button>
        <button class="btn" id="btnExport">ğŸ§¾</button>
      </div>
    </div>
  </header>
  <main id="main" tabindex="-1" aria-live="polite"></main>
  <footer>Â© <span id="y"></span> æƒ…ç»ªè®­ç»ƒ Â· é˜¶æ®µä¸€ Â· æœ¬åœ°è¿è¡Œ / iPad è§¦æ§ä¼˜åŒ–</footer>
</div>
<script>
(function(){
  const $=(s,el=document)=>el.querySelector(s);
  const $$=(s,el=document)=>Array.from(el.querySelectorAll(s));
  const DB_KEY='emo.stage1.v1';
  const state={score:{}, prefs:{speech:true}};
  const speak=(t)=>{ if(!state.prefs.speech) return; try{const u=new SpeechSynthesisUtterance(t);u.lang='zh-CN';speechSynthesis.cancel();speechSynthesis.speak(u);}catch(e){} };
  const save=()=>localStorage.setItem(DB_KEY,JSON.stringify(state));
  const load=()=>{try{const raw=localStorage.getItem(DB_KEY); if(raw) Object.assign(state, JSON.parse(raw));}catch(e){} };
  const bump=(gid,ok)=>{ const s=state.score[gid]||(state.score[gid]={ok:0,ng:0,best:0,last:''}); if(ok) s.ok++; else s.ng++; s.best=Math.max(s.best,s.ok); s.last=new Date().toLocaleString(); save(); };
  const csv=()=>{ const rows=[["game","ok","ng","best","last"]]; Object.entries(state.score).forEach(([g,s])=>rows.push([g,s.ok||0,s.ng||0,s.best||0,s.last||''])); return rows.map(r=>r.join(',')).join('\n'); };
  const download=(name,content)=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type:'text/plain;charset=utf-8;'})); a.download=name; a.click(); URL.revokeObjectURL(a.href); };

  function home(){
    const items=[
      {id:'g1',hash:'#g1',ico:'ğŸ˜Š',name:'(1) æƒ…ç»ªæŒ‡è®¤'},
      {id:'g2',hash:'#g2',ico:'ğŸ§©',name:'(2) æƒ…ç»ªé…å¯¹'},
      {id:'g3',hash:'#g3',ico:'ğŸ­',name:'(3) æƒ…ç»ªæ¨¡ä»¿(ç›¸æœº)'}
    ];
    $('#main').innerHTML=`<section class='sec'><h2>é€‰æ‹©ä¸€ä¸ªå°æ¸¸æˆå¼€å§‹</h2><div class='grid'>${items.map(x=>`<button class='tile' onclick="location.hash='${x.hash}'"><div class='ico'>${x.ico}</div><div>${x.name}</div><div class='meta'>æœ€ä½³ ${(state.score[x.id]?.best)||0}</div></button>`).join('')}</div><div class='row' style='margin-top:8px'><span class='chip'>è¯­éŸ³æ’­æŠ¥å·²${state.prefs.speech?'å¼€å¯':'å…³é—­'}</span><button class='btn' id='toggleSpeech'>ğŸ”Š åˆ‡æ¢è¯­éŸ³</button></div></section>`;
    $('#toggleSpeech').onclick=()=>{state.prefs.speech=!state.prefs.speech; save(); home();};
    speak('è¯·é€‰æ‹©ä¸€ä¸ªè®­ç»ƒå¼€å§‹ã€‚');
  }

  function report(){
    const list=Object.entries(state.score);
    $('#main').innerHTML=`<section class='sec'><div class='hero'><div class='ico'>ğŸ“ˆ</div><h2>å­¦ä¹ æŠ¥å‘Š</h2></div><div class='card'><table style='width:100%;border-collapse:collapse;font-size:14px'><thead><tr><th style='text-align:left;padding:6px;border-bottom:1px solid var(--line)'>æ¸¸æˆ</th><th style='text-align:right;padding:6px;border-bottom:1px solid var(--line)'>âœ…</th><th style='text-align:right;padding:6px;border-bottom:1px solid var(--line)'>âŒ</th><th style='text-align:right;padding:6px;border-bottom:1px solid var(--line)'>ğŸ†</th><th style='text-align:right;padding:6px;border-bottom:1px solid var(--line)'>æœ€è¿‘</th></tr></thead><tbody>${list.map(([g,s])=>`<tr><td style='padding:6px;border-bottom:1px dashed var(--line)'>${g}</td><td style='padding:6px;text-align:right;border-bottom:1px dashed var(--line)'>${s.ok||0}</td><td style='padding:6px;text-align:right;border-bottom:1px dashed var(--line)'>${s.ng||0}</td><td style='padding:6px;text-align:right;border-bottom:1px dashed var(--line)'>${s.best||0}</td><td style='padding:6px;text-align:right;border-bottom:1px dashed var(--line)'>${s.last||'â€”'}</td></tr>`).join('')}</tbody></table></div><div class='row' style='margin-top:8px'><span class='chip'>æœ¬åœ°ä¿å­˜ Â· å¯å¯¼å‡º CSV</span><button class='btn primary' id='back'>è¿”å›ä¸»é¡µ</button></div></section>`;
    $('#back').onclick=()=>{location.hash='#home'}
  }

  // ========== g1 æŒ‡è®¤ ==========
  function g1(){
    const all=[{emo:'é«˜å…´',icon:'ğŸ˜Š'},{emo:'ä¼¤å¿ƒ',icon:'ğŸ˜¢'},{emo:'ç”Ÿæ°”',icon:'ğŸ˜ '},{emo:'å®³æ€•',icon:'ğŸ˜¨'}];
    const s=state.score.g1||{}; const level=Math.min(4,2+Math.floor((s.best||0)/5));
    const pool=all.slice(0,level); const ans=pool[Math.floor(Math.random()*pool.length)];
    const opts=[...pool].sort(()=>Math.random()-.5);
    $('#main').innerHTML=`<section class='sec'><div class='hero'><div class='ico'>ğŸµ</div><h2>(1) æƒ…ç»ªæŒ‡è®¤</h2></div><div class='card'><div class='face'>${ans.icon}</div><p style='text-align:center;color:var(--muted)'>è¯·ç‚¹å‡»ï¼šè¿™æ˜¯ä»€ä¹ˆæƒ…ç»ªï¼Ÿ</p><div class='choices'>${opts.map(o=>`<button class='choice' data-v='${o.emo}'>${o.emo}</button>`).join('')}</div><div class='row' style='margin-top:8px'><span class='chip'>âœ… ${(s.ok||0)}ã€€âŒ ${(s.ng||0)}ã€€ğŸ† ${(s.best||0)}</span><div class='row' style='gap:6px'><button class='btn' id='speak'>ğŸ”Š</button><button class='btn primary' id='next'>ä¸‹ä¸€é¢˜</button></div></div></div></section>`;
    speak('è¿™æ˜¯ä»€ä¹ˆæƒ…ç»ªï¼Ÿ');
    $('#speak').onclick=()=>speak('è¿™æ˜¯ä»€ä¹ˆæƒ…ç»ªï¼Ÿ');
    $$('.choice').forEach(b=> b.onclick=()=>{ const ok=b.dataset.v===ans.emo; b.classList.add(ok?'good':'bad'); bump('g1',ok); speak(ok?`ä½ çœŸæ£’ï¼è¿™æ˜¯${ans.emo}`:`å†æƒ³æƒ³ï¼Œè¿™æ˜¯${ans.emo}å“¦`); setTimeout(()=>g1(),600); });
    $('#next').onclick=()=>g1();
  }

  // ========== g2 é…å¯¹ï¼ˆæ‹–æ‹½åˆ†ç±»ï¼‰ ==========
  function g2(){
    const targets=['é«˜å…´','ä¼¤å¿ƒ','ç”Ÿæ°”','å®³æ€•'];
    const icons={é«˜å…´:'ğŸ˜Š',ä¼¤å¿ƒ:'ğŸ˜¢',ç”Ÿæ°”:'ğŸ˜ ',å®³æ€•:'ğŸ˜¨'};
    const s=state.score.g2||{}; const k=Math.min(4,2+Math.floor((s.best||0)/4));
    const cats=targets.slice(0,k);
    const samples=cats.flatMap(c=>[{emo:c,label:`${icons[c]} ${c}â‘ `},{emo:c,label:`${icons[c]} ${c}â‘¡`}]).sort(()=>Math.random()-.5);
    $('#main').innerHTML=`<section class='sec'><div class='hero'><div class='ico'>ğŸµ</div><h2>(2) æƒ…ç»ªé…å¯¹</h2></div><div class='card'><div class='row'><span class='chip'>æŠŠç›¸åŒæƒ…ç»ªæ‹–åˆ°å¯¹åº”æ¡†å†…</span><span class='chip'>ç±»åˆ«ï¼š${k}</span></div><div class='drag-wrap' style='margin-top:8px'><div class='dropzone' id='src'>${samples.map(s=>`<div class='draggable' draggable='true' data-emo='${s.emo}'>${s.label}</div>`).join('')}</div><div class='drag-wrap'>${cats.map(c=>`<div class='dropzone' data-emo='${c}' aria-label='ç›®æ ‡ ${c}'><div class='chip'>ç›®æ ‡ï¼š${c}</div></div>`).join('')}</div></div><div class='row' style='margin-top:8px'><span class='chip'>âœ… ${(s.ok||0)}ã€€âŒ ${(s.ng||0)}ã€€ğŸ† ${(s.best||0)}</span><button class='btn primary' id='next'>ä¸‹ä¸€è½®</button></div></div></section>`;
    const onDragStart=(e)=>{ e.dataTransfer.setData('text/plain', e.target.dataset.emo); e.dataTransfer.dropEffect='move'; e.target.classList.add('dragging'); };
    const onDragEnd=(e)=>{ e.target.classList.remove('dragging'); };
    $$('.draggable').forEach(d=>{ d.addEventListener('dragstart',onDragStart); d.addEventListener('dragend',onDragEnd); });
    $$('.dropzone').forEach(z=>{
      z.addEventListener('dragover',e=>{e.preventDefault(); z.classList.add('over')});
      z.addEventListener('dragleave',()=>z.classList.remove('over'));
      z.addEventListener('drop',e=>{e.preventDefault(); z.classList.remove('over'); const expect=z.dataset.emo; const dragging=$('.dragging'); if(!dragging) return; const got=dragging.dataset.emo; if(expect===got){ z.appendChild(dragging); bump('g2',true); speak(`æ­£ç¡®ï¼Œ${expect}`); }else{ bump('g2',false); speak('ä¸æ˜¯è¿™é‡Œï¼Œè¯•è¯•åˆ«çš„ç›®æ ‡'); }
      });
    });
    $('#next').onclick=()=>g2();
  }

  // ========== g3 æ¨¡ä»¿ï¼ˆç›¸æœºï¼‰ ==========
  async function g3(){
    $('#main').innerHTML=`<section class='sec'><div class='hero'><div class='ico'>ğŸ­</div><h2>(3) æƒ…ç»ªæ¨¡ä»¿ï¼ˆç›¸æœºï¼‰</h2></div><div class='card camera'><div class='row'><span class='chip'>æç¤ºï¼šè·Ÿæˆ‘åšè¡¨æƒ…ï¼Œç„¶åè®©è€å¸ˆæŒ‰â€œå®Œæˆ/å†è¯•â€</span><button class='btn' id='openCam'>ğŸ“· æ‰“å¼€ç›¸æœº</button></div><video id='v' playsinline muted></video><div class='row'><button class='btn' data-emo='é«˜å…´'>ğŸ˜Š é«˜å…´</button><button class='btn' data-emo='ä¼¤å¿ƒ'>ğŸ˜¢ ä¼¤å¿ƒ</button><button class='btn' data-emo='ç”Ÿæ°”'>ğŸ˜  ç”Ÿæ°”</button><button class='btn' data-emo='å®³æ€•'>ğŸ˜¨ å®³æ€•</button></div><div class='row'><span class='chip' id='tip'>è¯·ç‚¹å‡»ä¸€ä¸ªè¡¨æƒ…å¼€å§‹æ¨¡ä»¿</span><div style='display:flex;gap:6px'><button class='btn' id='ok'>âœ… å®Œæˆ</button><button class='btn' id='retry'>â†» å†è¯•</button></div></div></div></section>`;
    let current=null; const tip=$('#tip');
    $('#openCam').onclick=async()=>{
      try{ const stream=await navigator.mediaDevices.getUserMedia({video:true,audio:false}); const v=$('#v'); v.srcObject=stream; await v.play(); }catch(e){ alert('æ— æ³•æ‰“å¼€æ‘„åƒå¤´ï¼š'+e.message); }
    };
    $$('.card .btn[data-emo]').forEach(b=> b.onclick=()=>{ current=b.dataset.emo; speak(`è¯·åšå‡º${current}çš„è¡¨æƒ…`); tip.textContent=`è¯·æ¨¡ä»¿ï¼š${current}`; });
    $('#ok').onclick=()=>{ if(!current){speak('è¯·é€‰æ‹©è¦æ¨¡ä»¿çš„è¡¨æƒ…');return;} bump('g3',true); speak('ä½ çœŸæ£’ï¼'); };
    $('#retry').onclick=()=>{ if(!current){speak('è¯·é€‰æ‹©è¦æ¨¡ä»¿çš„è¡¨æƒ…');return;} bump('g3',false); speak('å†è¯•ä¸€æ¬¡'); };
  }

  // è·¯ç”±
  const routes={'#home':home,'':home,'#report':report,'#g1':g1,'#g2':g2,'#g3':g3};
  function router(){ (routes[location.hash]||home)(); window.scrollTo({top:0,behavior:'instant'}); }

  // å…¨å±€æŒ‰é’®
  function bind(){
    $('#btnHome').onclick=()=>location.hash='#home';
    $('#btnReport').onclick=()=>location.hash='#report';
    $('#btnExport').onclick=()=>download('stage1_report.csv', csv());
  }

  // å¯åŠ¨
  load(); bind(); router(); window.addEventListener('hashchange',router); $('#y').textContent=new Date().getFullYear();
})();
</script>
</body>
</html>
